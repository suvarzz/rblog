---
title: "Dplyr tutorial"
author: "Mark Goldberg"
date: '`r format(Sys.time(), "%Y-%m-%d")`'
#weight: 1
draft: false
math: true
tags: ["R", "dplyr"]
categories: ["R"]
#bibliography: [bib.bib]
output:
  blogdown::html_page:
    toc: true
summary: "Dplyr tutorial."
---

## Short summary
```{r, eval=F}
# Select data
df %>% select(A, B)          # select fields
df %>% select(-B, -B)        # exclude fields
df %>% select(-c(A, B))      # select multiple fields
df %>% select(starts_with('a'))      # select by names of fields starting with ...
df %>% select(-starts_with('a'))        # exclude by names of fields starting with ...
df %>% select(contains('ab'))           # select by names of fields contains a literal string
df %>% select(ends_with('r'))           # Ends with a prefix
          # matches()	Matches a regular expression
          # num_range()	Numerical range like x01, x02, x03.
          # one_of()	Variables in character vector.
          # everything()	All variables.
df %>% select(A, everything())        # reorder variables, that A will be in the 1st column
df %>% select(C, B, A, everything())  # reordrer columns
df %>% select(C, B, A)                # the same as previous

# Filter rows

filter(df, A==1)
filter(df, A>1)
filter(df, Name %in% c('A','B'))
filter(df, Name %in% c('A','B') & C > 1)     # multiple filtering AND
filter(df, Name %in% c('A', 'B') | C == 1)   # multiple filtering OR
filter(df, !Name %in% c('A', 'B'))           # filtering NOT
filter(df, grepl("A", Name))    

# Adding rows and columns
df %>% mutate(mycol = NA)     # Add column 'mycol' filled with 'NA'
df %>% mutate(mycol = A*B)     # Add column 'mycol' as A*B
df=data.frame(A=c(1,2), B=c(3,4))
df %>% cbind(mycol = NA)
df %>% rbind(myrow = NA)      # add 'myrow' filled 'NA'

# Remove duplicates
df %>% distinct()                       # remove duplicated rows
df %>% distinct(A, .keep_all=TRUE)      # remove rows when field 'A' is duplicated
df %>% distinct(A, B, .keep_all=TRUE)   # remove rows when several fields at the same row are duplicated

# Compair data
all_equal(x,y)      # compair two data frames

# Combine data
intersect(x, y)     # Rows that appear in both x and y.
union(x, y)         # Rows that appear in either or both x and y.
setdiff(x, y)       # Rows that appear in x but not y.

# Sort
arrange(df, A)           # Sort rows by A column
arrange(df, desc(A))     # Sort by descendence of values in column A
arrange(df, A, B)        # Sort by A & B

group_by(df, A, B)

inner_join(x, y, by = )
left_join(x, y, by = )
right_join(x, y, by = )
full_join(x, y, by = )
semi_join(x, y, by = )
anti_join(x, y, by = )

# Miscellaneous
df %>% na_if("")            # Convert empty spaces to 'NA'
sample_frac(df, size=0.8)   # Randomly select fraction of rows
```



```{r, message=F}
library(dplyr)
```

```{r}
# toy data
df <- data.frame("Age" = c(10,15,10,15), "Name" = c("A","B", "C", "B"), "Gender"=c(1,0,1,0))
df
```

## Adding rows and columns
```{r}
df %>% mutate(N = NA)    # add new last column 'N' filled NA
df %>% rbind(N = NA)     # add new last row 'N' filled 'NA'
```

## Remove duplicates
```{r}
df %>% distinct()                                # remove duplicated rows
df %>% distinct(Age, .keep_all=TRUE)             # remove rows when field 'Age' is duplicated
df %>% distinct(Age, Gender, .keep_all=TRUE)     # remove rows when fields 'A' & 'B' are duplicated
```

## Select
```{r}
df %>% select(Name, Gender)          # select fields
df %>% select(-Name, -Gender)        # exclude fields
df %>% select(-c(Name, Gender))      # same as privious
df %>% select(starts_with("A"))      # select names of fields: A -> Age
select(df, -starts_with("A"))        # select all except A -> Age
select(df, contains("G"))            # Contains a literal string
select(df, ends_with("r"))           # Ends with a prefix
          # matches()	Matches a regular expression
          # num_range()	Numerical range like x01, x02, x03.
          # one_of()	Variables in character vector.
          # everything()	All variables.
select(df, Age, everything())        # reorder variables, that Age will be in the 1st column
select(df, Gender, Age, Name, everything()) # reordrer columns
select(df, Gender, Age, Name)               # the same as previous
```

## Filter rows
```{r}
filter(df, Gender==1)
filter(df, Age>10)
filter(df, Name %in% c('A','B'))
filter(df, Name %in% c('A','B') & Age > 10)     # multiple filtering AND
filter(df, Name %in% c('A', 'B') | Gender == 1) # multiple filtering OR
filter(df, !Name %in% c('A', 'B'))              # filtering NOT
filter(df, grepl("A", Name))                    # grepl function
```

## Summarize

summarize(df, avg = mean(Age), m = median(Age))

summarise_at(df, vars(Gender, Age), funs(n(), mean, median)) # multiple functions
summarise_if(df, is.numeric, funs(n(),mean,median))          # for all numeric columns
summarise_at(df, vars(Gender,Age), function(x) var(x - mean(x))) # custom function

summarise
summarize_all  # Allply funs to every column
summarize_at   # Apply funs to specific columns
summarize_if   # Apply funs to all cols of one type


## Sort
```{r}
arrange(df, Age)
arrange(df, desc(Age))
arrange(df, Age, Name)

group_by(df, Age, Name) # ???
```

## Pipes
```{r}
df %>% select(Age, Name) %>% arrange(Age) %>% filter(Name %in% c('C','B')) %>% distinct() # select columns and sort by and select rows and remove duplicated rows
```
## Combine data
intersect(x, y)              # Rows that appear in both x and y.
union(x, y)                  # Rows that appear in either or both x and y.
setdiff(x, y)                # Rows that appear in x but not y.

## 'by' is a common variable (primary key) to join by.

inner_join(x, y, by = )
left_join(x, y, by = )
right_join(x, y, by = )
full_join(x, y, by = )
semi_join(x, y, by = )
anti_join(x, y, by = )

if_else(condition, true, false, missing = NULL)
mydf =data.frame(x = c(1:5,NA))

# Nested If_Else
mydf %>% mutate(newvar= if_else(is.na(x),"I am missing",
                        if_else(x==1,"I am one",
                        if_else(x==2,"I am two",
                        if_else(x==3,"I am three","Others")))))
#TODO
bind_rows()
bind_cols()
ntile()

# if() Family of Functions 
#TODO
select_if
mutate_if
pull()

# Vectorize functions to columns
mutate
transmute
mutate_all
mutate_at
add_column
rename
      
## How to ...
### Convert empty spaces to NA
```{r}
df <- c("a", "b", "", "d")
df %>% na_if("")              # "a" "b" NA  "d"
```
### Randomly select n rows
```{r}
df <- data.frame(A=seq(1:10), B=seq(.1,1,.1))
df %>% sample_frac(size=0.3)   # Randomly select fraction of rows
```

sample_n(df, size, ...) # Randomly select size rows
slice(df   # select rows by position

## Sources
