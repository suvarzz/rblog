---
title: "Dplyr tutorial"
author: "Mark Goldberg"
date: '2019-08-09'
#weight: 1
draft: false
math: true
tags: ["R", "dplyr"]
categories: ["R"]
#bibliography: [bib.bib]
output:
  blogdown::html_page:
    toc: true
summary: "Dplyr tutorial."
---


<div id="TOC">
<ul>
<li><a href="#short-summary">Short summary</a></li>
<li><a href="#adding-rows-and-columns">Adding rows and columns</a></li>
<li><a href="#remove-duplicates">Remove duplicates</a></li>
<li><a href="#select">Select</a></li>
<li><a href="#filter-rows">Filter rows</a></li>
<li><a href="#summarize">Summarize</a></li>
<li><a href="#sort">Sort</a></li>
<li><a href="#pipes">Pipes</a></li>
<li><a href="#combine-data">Combine data</a></li>
<li><a href="#by-is-a-common-variable-primary-key-to-join-by.">‘by’ is a common variable (primary key) to join by.</a></li>
<li><a href="#nested-if_else">Nested If_Else</a></li>
<li><a href="#if-family-of-functions">if() Family of Functions</a></li>
<li><a href="#todo">TODO</a></li>
<li><a href="#vectorize-functions-to-columns">Vectorize functions to columns</a><ul>
<li><a href="#how-to">How to …</a><ul>
<li><a href="#convert-empty-spaces-to-na">Convert empty spaces to NA</a></li>
<li><a href="#randomly-select-n-rows">Randomly select n rows</a></li>
</ul></li>
<li><a href="#sources">Sources</a></li>
</ul></li>
</ul>
</div>

<div id="short-summary" class="section level2">
<h2>Short summary</h2>
<pre class="r"><code># Select data
df %&gt;% select(A, B)          # select fields
df %&gt;% select(-B, -B)        # exclude fields
df %&gt;% select(-c(A, B))      # select multiple fields
df %&gt;% select(starts_with(&#39;a&#39;))      # select by names of fields starting with ...
df %&gt;% select(-starts_with(&#39;a&#39;))        # exclude by names of fields starting with ...
df %&gt;% select(contains(&#39;ab&#39;))           # select by names of fields contains a literal string
df %&gt;% select(ends_with(&#39;r&#39;))           # Ends with a prefix
          # matches()   Matches a regular expression
          # num_range() Numerical range like x01, x02, x03.
          # one_of()    Variables in character vector.
          # everything()    All variables.
df %&gt;% select(A, everything())        # reorder variables, that A will be in the 1st column
df %&gt;% select(C, B, A, everything())  # reordrer columns
df %&gt;% select(C, B, A)                # the same as previous

# Filter rows

filter(df, A==1)
filter(df, A&gt;1)
filter(df, Name %in% c(&#39;A&#39;,&#39;B&#39;))
filter(df, Name %in% c(&#39;A&#39;,&#39;B&#39;) &amp; C &gt; 1)     # multiple filtering AND
filter(df, Name %in% c(&#39;A&#39;, &#39;B&#39;) | C == 1)   # multiple filtering OR
filter(df, !Name %in% c(&#39;A&#39;, &#39;B&#39;))           # filtering NOT
filter(df, grepl(&quot;A&quot;, Name))    

# Adding rows and columns
df %&gt;% mutate(mycol = NA)     # Add column &#39;mycol&#39; filled with &#39;NA&#39;
df %&gt;% mutate(mycol = A*B)     # Add column &#39;mycol&#39; as A*B
df=data.frame(A=c(1,2), B=c(3,4))
df %&gt;% cbind(mycol = NA)
df %&gt;% rbind(myrow = NA)      # add &#39;myrow&#39; filled &#39;NA&#39;

# Remove duplicates
df %&gt;% distinct()                       # remove duplicated rows
df %&gt;% distinct(A, .keep_all=TRUE)      # remove rows when field &#39;A&#39; is duplicated
df %&gt;% distinct(A, B, .keep_all=TRUE)   # remove rows when several fields at the same row are duplicated

# Compair data
all_equal(x,y)      # compair two data frames

# Combine data
intersect(x, y)     # Rows that appear in both x and y.
union(x, y)         # Rows that appear in either or both x and y.
setdiff(x, y)       # Rows that appear in x but not y.

# Sort
arrange(df, A)           # Sort rows by A column
arrange(df, desc(A))     # Sort by descendence of values in column A
arrange(df, A, B)        # Sort by A &amp; B

group_by(df, A, B)

inner_join(x, y, by = )
left_join(x, y, by = )
right_join(x, y, by = )
full_join(x, y, by = )
semi_join(x, y, by = )
anti_join(x, y, by = )

# Miscellaneous
df %&gt;% na_if(&quot;&quot;)            # Convert empty spaces to &#39;NA&#39;
sample_frac(df, size=0.8)   # Randomly select fraction of rows</code></pre>
<pre class="r"><code>library(dplyr)</code></pre>
<pre class="r"><code># toy data
df &lt;- data.frame(&quot;Age&quot; = c(10,15,10,15), &quot;Name&quot; = c(&quot;A&quot;,&quot;B&quot;, &quot;C&quot;, &quot;B&quot;), &quot;Gender&quot;=c(1,0,1,0))
df</code></pre>
<pre><code>##   Age Name Gender
## 1  10    A      1
## 2  15    B      0
## 3  10    C      1
## 4  15    B      0</code></pre>
</div>
<div id="adding-rows-and-columns" class="section level2">
<h2>Adding rows and columns</h2>
<pre class="r"><code>df %&gt;% mutate(N = NA)    # add new last column &#39;N&#39; filled NA</code></pre>
<pre><code>##   Age Name Gender  N
## 1  10    A      1 NA
## 2  15    B      0 NA
## 3  10    C      1 NA
## 4  15    B      0 NA</code></pre>
<pre class="r"><code>df %&gt;% rbind(N = NA)     # add new last row &#39;N&#39; filled &#39;NA&#39;</code></pre>
<pre><code>##   Age Name Gender
## 1  10    A      1
## 2  15    B      0
## 3  10    C      1
## 4  15    B      0
## 5  NA &lt;NA&gt;     NA</code></pre>
</div>
<div id="remove-duplicates" class="section level2">
<h2>Remove duplicates</h2>
<pre class="r"><code>df %&gt;% distinct()                                # remove duplicated rows</code></pre>
<pre><code>##   Age Name Gender
## 1  10    A      1
## 2  15    B      0
## 3  10    C      1</code></pre>
<pre class="r"><code>df %&gt;% distinct(Age, .keep_all=TRUE)             # remove rows when field &#39;Age&#39; is duplicated</code></pre>
<pre><code>##   Age Name Gender
## 1  10    A      1
## 2  15    B      0</code></pre>
<pre class="r"><code>df %&gt;% distinct(Age, Gender, .keep_all=TRUE)     # remove rows when fields &#39;A&#39; &amp; &#39;B&#39; are duplicated</code></pre>
<pre><code>##   Age Name Gender
## 1  10    A      1
## 2  15    B      0</code></pre>
</div>
<div id="select" class="section level2">
<h2>Select</h2>
<pre class="r"><code>df %&gt;% select(Name, Gender)          # select fields</code></pre>
<pre><code>##   Name Gender
## 1    A      1
## 2    B      0
## 3    C      1
## 4    B      0</code></pre>
<pre class="r"><code>df %&gt;% select(-Name, -Gender)        # exclude fields</code></pre>
<pre><code>##   Age
## 1  10
## 2  15
## 3  10
## 4  15</code></pre>
<pre class="r"><code>df %&gt;% select(-c(Name, Gender))      # same as privious</code></pre>
<pre><code>##   Age
## 1  10
## 2  15
## 3  10
## 4  15</code></pre>
<pre class="r"><code>df %&gt;% select(starts_with(&quot;A&quot;))      # select names of fields: A -&gt; Age</code></pre>
<pre><code>##   Age
## 1  10
## 2  15
## 3  10
## 4  15</code></pre>
<pre class="r"><code>select(df, -starts_with(&quot;A&quot;))        # select all except A -&gt; Age</code></pre>
<pre><code>##   Name Gender
## 1    A      1
## 2    B      0
## 3    C      1
## 4    B      0</code></pre>
<pre class="r"><code>select(df, contains(&quot;G&quot;))            # Contains a literal string</code></pre>
<pre><code>##   Age Gender
## 1  10      1
## 2  15      0
## 3  10      1
## 4  15      0</code></pre>
<pre class="r"><code>select(df, ends_with(&quot;r&quot;))           # Ends with a prefix</code></pre>
<pre><code>##   Gender
## 1      1
## 2      0
## 3      1
## 4      0</code></pre>
<pre class="r"><code>          # matches()   Matches a regular expression
          # num_range() Numerical range like x01, x02, x03.
          # one_of()    Variables in character vector.
          # everything()    All variables.
select(df, Age, everything())        # reorder variables, that Age will be in the 1st column</code></pre>
<pre><code>##   Age Name Gender
## 1  10    A      1
## 2  15    B      0
## 3  10    C      1
## 4  15    B      0</code></pre>
<pre class="r"><code>select(df, Gender, Age, Name, everything()) # reordrer columns</code></pre>
<pre><code>##   Gender Age Name
## 1      1  10    A
## 2      0  15    B
## 3      1  10    C
## 4      0  15    B</code></pre>
<pre class="r"><code>select(df, Gender, Age, Name)               # the same as previous</code></pre>
<pre><code>##   Gender Age Name
## 1      1  10    A
## 2      0  15    B
## 3      1  10    C
## 4      0  15    B</code></pre>
</div>
<div id="filter-rows" class="section level2">
<h2>Filter rows</h2>
<pre class="r"><code>filter(df, Gender==1)</code></pre>
<pre><code>##   Age Name Gender
## 1  10    A      1
## 2  10    C      1</code></pre>
<pre class="r"><code>filter(df, Age&gt;10)</code></pre>
<pre><code>##   Age Name Gender
## 1  15    B      0
## 2  15    B      0</code></pre>
<pre class="r"><code>filter(df, Name %in% c(&#39;A&#39;,&#39;B&#39;))</code></pre>
<pre><code>##   Age Name Gender
## 1  10    A      1
## 2  15    B      0
## 3  15    B      0</code></pre>
<pre class="r"><code>filter(df, Name %in% c(&#39;A&#39;,&#39;B&#39;) &amp; Age &gt; 10)     # multiple filtering AND</code></pre>
<pre><code>##   Age Name Gender
## 1  15    B      0
## 2  15    B      0</code></pre>
<pre class="r"><code>filter(df, Name %in% c(&#39;A&#39;, &#39;B&#39;) | Gender == 1) # multiple filtering OR</code></pre>
<pre><code>##   Age Name Gender
## 1  10    A      1
## 2  15    B      0
## 3  10    C      1
## 4  15    B      0</code></pre>
<pre class="r"><code>filter(df, !Name %in% c(&#39;A&#39;, &#39;B&#39;))              # filtering NOT</code></pre>
<pre><code>##   Age Name Gender
## 1  10    C      1</code></pre>
<pre class="r"><code>filter(df, grepl(&quot;A&quot;, Name))                    # grepl function</code></pre>
<pre><code>##   Age Name Gender
## 1  10    A      1</code></pre>
</div>
<div id="summarize" class="section level2">
<h2>Summarize</h2>
<p>summarize(df, avg = mean(Age), m = median(Age))</p>
<p>summarise_at(df, vars(Gender, Age), funs(n(), mean, median)) # multiple functions summarise_if(df, is.numeric, funs(n(),mean,median)) # for all numeric columns summarise_at(df, vars(Gender,Age), function(x) var(x - mean(x))) # custom function</p>
<p>summarise summarize_all # Allply funs to every column summarize_at # Apply funs to specific columns summarize_if # Apply funs to all cols of one type</p>
</div>
<div id="sort" class="section level2">
<h2>Sort</h2>
<pre class="r"><code>arrange(df, Age)</code></pre>
<pre><code>##   Age Name Gender
## 1  10    A      1
## 2  10    C      1
## 3  15    B      0
## 4  15    B      0</code></pre>
<pre class="r"><code>arrange(df, desc(Age))</code></pre>
<pre><code>##   Age Name Gender
## 1  15    B      0
## 2  15    B      0
## 3  10    A      1
## 4  10    C      1</code></pre>
<pre class="r"><code>arrange(df, Age, Name)</code></pre>
<pre><code>##   Age Name Gender
## 1  10    A      1
## 2  10    C      1
## 3  15    B      0
## 4  15    B      0</code></pre>
<pre class="r"><code>group_by(df, Age, Name) # ???</code></pre>
<pre><code>## # A tibble: 4 x 3
## # Groups:   Age, Name [3]
##     Age Name  Gender
##   &lt;dbl&gt; &lt;fct&gt;  &lt;dbl&gt;
## 1    10 A          1
## 2    15 B          0
## 3    10 C          1
## 4    15 B          0</code></pre>
</div>
<div id="pipes" class="section level2">
<h2>Pipes</h2>
<pre class="r"><code>df %&gt;% select(Age, Name) %&gt;% arrange(Age) %&gt;% filter(Name %in% c(&#39;C&#39;,&#39;B&#39;)) %&gt;% distinct() # select columns and sort by and select rows and remove duplicated rows</code></pre>
<pre><code>##   Age Name
## 1  10    C
## 2  15    B</code></pre>
</div>
<div id="combine-data" class="section level2">
<h2>Combine data</h2>
<p>intersect(x, y) # Rows that appear in both x and y. union(x, y) # Rows that appear in either or both x and y. setdiff(x, y) # Rows that appear in x but not y.</p>
</div>
<div id="by-is-a-common-variable-primary-key-to-join-by." class="section level2">
<h2>‘by’ is a common variable (primary key) to join by.</h2>
<p>inner_join(x, y, by = ) left_join(x, y, by = ) right_join(x, y, by = ) full_join(x, y, by = ) semi_join(x, y, by = ) anti_join(x, y, by = )</p>
<p>if_else(condition, true, false, missing = NULL) mydf =data.frame(x = c(1:5,NA))</p>
</div>
<div id="nested-if_else" class="section level1">
<h1>Nested If_Else</h1>
<p>mydf %&gt;% mutate(newvar= if_else(is.na(x),“I am missing”, if_else(x==1,“I am one”, if_else(x==2,“I am two”, if_else(x==3,“I am three”,“Others”))))) #TODO bind_rows() bind_cols() ntile()</p>
</div>
<div id="if-family-of-functions" class="section level1">
<h1>if() Family of Functions</h1>
</div>
<div id="todo" class="section level1">
<h1>TODO</h1>
<p>select_if mutate_if pull()</p>
</div>
<div id="vectorize-functions-to-columns" class="section level1">
<h1>Vectorize functions to columns</h1>
<p>mutate transmute mutate_all mutate_at add_column rename</p>
<div id="how-to" class="section level2">
<h2>How to …</h2>
<div id="convert-empty-spaces-to-na" class="section level3">
<h3>Convert empty spaces to NA</h3>
<pre class="r"><code>df &lt;- c(&quot;a&quot;, &quot;b&quot;, &quot;&quot;, &quot;d&quot;)
df %&gt;% na_if(&quot;&quot;)              # &quot;a&quot; &quot;b&quot; NA  &quot;d&quot;</code></pre>
<pre><code>## [1] &quot;a&quot; &quot;b&quot; NA  &quot;d&quot;</code></pre>
</div>
<div id="randomly-select-n-rows" class="section level3">
<h3>Randomly select n rows</h3>
<pre class="r"><code>df &lt;- data.frame(A=seq(1:10), B=seq(.1,1,.1))
df %&gt;% sample_frac(size=0.3)   # Randomly select fraction of rows</code></pre>
<pre><code>##    A   B
## 1  2 0.2
## 2  9 0.9
## 3 10 1.0</code></pre>
<p>sample_n(df, size, …) # Randomly select size rows slice(df # select rows by position</p>
</div>
</div>
<div id="sources" class="section level2">
<h2>Sources</h2>
</div>
</div>
